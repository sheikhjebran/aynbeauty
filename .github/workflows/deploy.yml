name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Copy production environment file
        run: cp .env.prod .env.local

      - name: Build application with static assets
        run: npm run build

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          envs: DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,NODE_ENV
          script: |
            echo "ğŸš€ Starting deployment..."
            set -e  # Exit on error

            # Navigate to project directory
            cd /var/www/aynbeauty
            PROJECT_DIR=$(pwd)
            BACKUP_DIR="/var/backups/aynbeauty"
            IMAGES_DIR="$PROJECT_DIR/public/uploads/products"
            BACKUP_IMAGES_DIR="$BACKUP_DIR/product-images-$(date +%Y%m%d-%H%M%S)"

            # Create backup directory if it doesn't exist
            mkdir -p "$BACKUP_DIR"
            mkdir -p "$IMAGES_DIR"

            echo "ğŸ“¸ Creating backup of product images..."
            if [ -d "$IMAGES_DIR" ] && [ "$(ls -A $IMAGES_DIR)" ]; then
              mkdir -p "$BACKUP_IMAGES_DIR"
              cp -r "$IMAGES_DIR"/* "$BACKUP_IMAGES_DIR/" 2>/dev/null || echo "âš ï¸ No existing images to backup"
              echo "âœ… Product images backed up to: $BACKUP_IMAGES_DIR"
              LATEST_BACKUP="$BACKUP_IMAGES_DIR"
            else
              echo "â„¹ï¸ No existing product images found"
            fi

            # Stop and delete the application from PM2
            echo "â¹ï¸ Stopping application..."
            if pm2 desc aynbeauty > /dev/null 2>&1; then
              pm2 delete aynbeauty
              sleep 2
              echo "âœ… Application removed from PM2"
            else
              echo "â„¹ï¸ Application not running in PM2"
            fi

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from main..."
            git config --global --add safe.directory /var/www/aynbeauty
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Code updated"

            # Copy production environment
            echo "ğŸ“‹ Setting up production environment..."
            if [ -f ".env.prod" ]; then
              cp .env.prod .env.local
              echo "âœ… Production environment file copied"
            else
              echo "âš ï¸ Warning: .env.prod not found, using existing .env.local"
            fi

            # Clean build artifacts to prevent stale cache issues
            echo "ğŸ§¹ Cleaning old build artifacts..."
            rm -rf .next .next-backup dist .turbo node_modules/.cache || true
            echo "âœ… Old artifacts cleaned"

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --production=false
            echo "âœ… Dependencies installed"

            # Build the application with post-build static asset copying
            echo "ğŸ”¨ Building Next.js application with static assets..."
            npm run build
            if [ $? -eq 0 ]; then
              echo "âœ… Build completed successfully"
            else
              echo "âŒ Build failed! Rolling back..."
              exit 1
            fi

            # Verify standalone structure
            echo "ğŸ” Verifying standalone build structure..."
            if [ ! -d ".next/standalone/.next/static" ]; then
              echo "âŒ Static assets not found in standalone build!"
              exit 1
            fi
            if [ ! -d ".next/standalone/public" ]; then
              echo "âŒ Public directory not found in standalone build!"
              exit 1
            fi
            STATIC_COUNT=$(find .next/standalone/.next/static -type f | wc -l)
            PUBLIC_COUNT=$(find .next/standalone/public -type f | wc -l)
            echo "âœ… Static files verified: $STATIC_COUNT files"
            echo "âœ… Public files verified: $PUBLIC_COUNT files"

            # Restore product images
            echo "ğŸ“¸ Restoring product images..."
            mkdir -p "$IMAGES_DIR"
            if [ -d "$LATEST_BACKUP" ] && [ "$(ls -A $LATEST_BACKUP)" ]; then
              cp -r "$LATEST_BACKUP"/* "$IMAGES_DIR/" 2>/dev/null
              echo "âœ… Product images restored"
            else
              echo "â„¹ï¸ No backup images to restore"
            fi

            # Update database schema (if migration exists)
            echo "ğŸ—„ï¸ Updating database schema..."
            DB_HOST="${DB_HOST:-127.0.0.1}"
            DB_PORT="${DB_PORT:-3306}"
            if [ -f "migrate-image-urls.sql" ]; then
              mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < migrate-image-urls.sql && echo "âœ… Database migration completed" || echo "âš ï¸ Database migration skipped"
            else
              echo "â„¹ï¸ No database migrations to run"
            fi

            # Set proper permissions
            echo "ğŸ” Setting file permissions..."
            sudo chown -R www-data:www-data "$PROJECT_DIR" 2>/dev/null || chown -R nobody "$PROJECT_DIR"
            sudo chmod -R 755 "$PROJECT_DIR" 2>/dev/null || chmod -R 755 "$PROJECT_DIR"
            sudo chmod -R 775 "$IMAGES_DIR" 2>/dev/null || chmod -R 775 "$IMAGES_DIR"
            echo "âœ… Permissions set"

            # Start the application with PM2
            echo "ğŸ”„ Starting application with PM2..."
            pm2 start ecosystem.config.js
            pm2 save
            echo "âœ… Application started"

            # Wait for application to be ready - increased timeout
            echo "â³ Waiting for application startup..."
            sleep 10

            # Show PM2 status
            echo "ğŸ“Š PM2 Application status:"
            pm2 status
            echo ""
            pm2 info aynbeauty || true

            # Test the application health with extended timeout
            echo "ğŸ§ª Testing application health..."
            RETRY_COUNT=0
            MAX_RETRIES=10
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3000/api/health --max-time 30 --silent > /dev/null 2>&1; then
                echo "âœ… Health check passed - Application is healthy"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
                  # Show current status
                  pm2 status || true
                  sleep 5
                else
                  echo "âš ï¸ Health check failed after $MAX_RETRIES attempts"
                  echo "Application is likely still booting or has errors. Showing last errors:"
                  tail -50 "$PROJECT_DIR/logs/aynbeauty-error.log" 2>/dev/null || echo "No error log available"
                  echo ""
                  echo "Full PM2 status:"
                  pm2 info aynbeauty || pm2 status
                fi
              fi
            done

            # Test static asset accessibility
            echo "ğŸ§ª Testing static assets..."
            if curl -s http://localhost:3000/_next/static/ --max-time 10 | head -c 100 > /dev/null 2>&1; then
              echo "âœ… Static assets accessible"
            else
              echo "âš ï¸ Could not verify static assets accessibility"
            fi

            # Verify backups are accessible
            echo "ğŸ“‚ Backup information:"
            echo "Backup directory: $BACKUP_DIR"
            if [ -d "$BACKUP_DIR" ]; then
              ls -lh "$BACKUP_DIR" | tail -5 || echo "No backups found"
            fi

            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application running at: http://66.116.199.206:3000"
            echo "ğŸ“Š To check logs: pm2 logs aynbeauty"
            echo "ğŸ”„ To restart manually: pm2 restart aynbeauty"
            echo "â¹ï¸ To stop: pm2 stop aynbeauty"

      - name: Notify deployment success
        if: success()
        run: echo "âœ… Deployment completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."
          exit 1
