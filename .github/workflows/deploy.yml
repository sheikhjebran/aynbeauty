name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Copy production environment file
        run: cp .env.prod .env.local

      - name: Build application with static assets
        run: npm run build

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          envs: DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,NODE_ENV
          script: |
            echo "üöÄ Starting deployment..."
            set -e  # Exit on error

            # Navigate to project directory
            cd /var/www/aynbeauty
            PROJECT_DIR=$(pwd)
            BACKUP_DIR="/var/backups/aynbeauty"
            IMAGES_DIR="$PROJECT_DIR/public/uploads/products"
            BACKUP_IMAGES_DIR="$BACKUP_DIR/product-images-$(date +%Y%m%d-%H%M%S)"

            # Create backup directory if it doesn't exist
            mkdir -p "$BACKUP_DIR"
            mkdir -p "$IMAGES_DIR"

            echo "üì∏ Creating backup of product images..."
            if [ -d "$IMAGES_DIR" ] && [ "$(ls -A $IMAGES_DIR)" ]; then
              mkdir -p "$BACKUP_IMAGES_DIR"
              cp -r "$IMAGES_DIR"/* "$BACKUP_IMAGES_DIR/" 2>/dev/null || echo "‚ö†Ô∏è No existing images to backup"
              echo "‚úÖ Product images backed up to: $BACKUP_IMAGES_DIR"
              LATEST_BACKUP="$BACKUP_IMAGES_DIR"
            else
              echo "‚ÑπÔ∏è No existing product images found"
            fi

            # Stop and delete the application from PM2
            echo "‚èπÔ∏è Stopping application..."
            if pm2 desc aynbeauty > /dev/null 2>&1; then
              pm2 delete aynbeauty
              sleep 2
              echo "‚úÖ Application removed from PM2"
            else
              echo "‚ÑπÔ∏è Application not running in PM2"
            fi

            # Pull latest changes
            echo "üì• Pulling latest changes from main..."
            git config --global --add safe.directory /var/www/aynbeauty
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ Code updated"

            # Setup production environment
            echo "üìã Setting up production environment..."
            # Delete local env file if exists
            if [ -f ".env.local" ]; then
              rm .env.local
              echo "üóëÔ∏è Deleted .env.local (local development env)"
            fi
            # Rename production env to .env.local
            if [ -f ".env.prod" ]; then
              mv .env.prod .env.local
              echo "‚úÖ Production environment activated (.env.prod ‚Üí .env.local)"
            else
              echo "‚ùå ERROR: .env.prod not found!"
              exit 1
            fi

            # Clean build artifacts to prevent stale cache issues
            echo "üßπ Cleaning old build artifacts..."
            rm -rf .next .next-backup dist .turbo node_modules/.cache || true
            echo "‚úÖ Old artifacts cleaned"

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production=false
            echo "‚úÖ Dependencies installed"

            # Build the application with post-build static asset copying
            echo "üî® Building Next.js application with static assets..."
            npm run build
            if [ $? -eq 0 ]; then
              echo "‚úÖ Build completed successfully"
            else
              echo "‚ùå Build failed! Rolling back..."
              exit 1
            fi

            # Verify standalone structure
            echo "üîç Verifying standalone build structure..."
            if [ ! -d ".next/standalone/.next/static" ]; then
              echo "‚ùå Static assets not found in standalone build!"
              exit 1
            fi
            if [ ! -d ".next/standalone/public" ]; then
              echo "‚ùå Public directory not found in standalone build!"
              exit 1
            fi
            STATIC_COUNT=$(find .next/standalone/.next/static -type f | wc -l)
            PUBLIC_COUNT=$(find .next/standalone/public -type f | wc -l)
            echo "‚úÖ Static files verified: $STATIC_COUNT files"
            echo "‚úÖ Public files verified: $PUBLIC_COUNT files"

            # Ensure public files are in standalone FIRST
            echo "üìÅ Syncing public files to standalone..."
            rsync -av public/ .next/standalone/public/ 2>/dev/null || cp -rf public/* .next/standalone/public/ 2>/dev/null || true
            echo "‚úÖ Public files synced"

            # Restore product images AFTER syncing public (so they don't get deleted by rsync --delete)
            echo "üì∏ Restoring product images..."
            mkdir -p "$IMAGES_DIR"
            mkdir -p ".next/standalone/public/uploads/products"
            if [ -d "$LATEST_BACKUP" ] && [ "$(ls -A $LATEST_BACKUP)" ]; then
              cp -r "$LATEST_BACKUP"/* "$IMAGES_DIR/" 2>/dev/null || true
              cp -r "$LATEST_BACKUP"/* ".next/standalone/public/uploads/products/" 2>/dev/null || true
              IMAGE_COUNT=$(find "$IMAGES_DIR" -type f 2>/dev/null | wc -l)
              echo "‚úÖ Product images restored to both locations ($IMAGE_COUNT files)"
            else
              echo "‚ÑπÔ∏è No backup images to restore"
            fi

            # Copy environment variables to standalone
            echo "üîê Copying environment variables to standalone..."
            if [ -f ".env.local" ]; then
              cp .env.local .next/standalone/.env.local
              # Verify database credentials are present
              if grep -q "DB_PASSWORD" .env.local && grep -q "DB_NAME" .env.local; then
                echo "‚úÖ Environment variables copied to standalone (DB credentials verified)"
              else
                echo "‚ö†Ô∏è Warning: Database credentials may be missing in .env.local"
              fi
            else
              echo "‚ùå ERROR: .env.local not found!"
              exit 1
            fi

            # Update database schema (if migration exists)
            echo "üóÑÔ∏è Updating database schema..."
            DB_HOST="${DB_HOST:-127.0.0.1}"
            DB_PORT="${DB_PORT:-3306}"
            if [ -f "migrate-image-urls.sql" ]; then
              mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < migrate-image-urls.sql && echo "‚úÖ Database migration completed" || echo "‚ö†Ô∏è Database migration skipped"
            else
              echo "‚ÑπÔ∏è No database migrations to run"
            fi

            # Set proper permissions
            echo "üîê Setting file permissions..."
            sudo chown -R www-data:www-data "$PROJECT_DIR" 2>/dev/null || chown -R nobody "$PROJECT_DIR"
            sudo chmod -R 755 "$PROJECT_DIR" 2>/dev/null || chmod -R 755 "$PROJECT_DIR"
            sudo chmod -R 775 "$IMAGES_DIR" 2>/dev/null || chmod -R 775 "$IMAGES_DIR"
            echo "‚úÖ Permissions set"

            # Verify environment file in standalone
            echo "üîç Verifying environment configuration..."
            if [ -f ".next/standalone/.env.local" ]; then
              echo "‚úÖ .env.local exists in standalone directory"
              echo "Environment variables loaded:"
              grep -E "^(DB_HOST|DB_NAME|NODE_ENV|PORT)=" .next/standalone/.env.local | sed 's/=.*/=***/' || echo "Could not read env file"
            else
              echo "‚ùå .env.local NOT FOUND in standalone directory!"
              exit 1
            fi

            # Start the application with PM2
            echo "üîÑ Starting application with PM2..."
            pm2 start ecosystem.config.js --update-env
            pm2 save
            echo "‚úÖ Application started"

            # Show PM2 status
            echo "üìä PM2 Status:"
            pm2 list

            # Wait for application to be ready - increased timeout
            echo "‚è≥ Waiting for application startup..."
            sleep 10

            # Show PM2 status
            echo "üìä PM2 Application status:"
            pm2 status
            echo ""
            pm2 info aynbeauty || true

            # Test the application health with extended timeout
            echo "üß™ Testing application health..."
            RETRY_COUNT=0
            MAX_RETRIES=10
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3000/api/health --max-time 30 --silent > /dev/null 2>&1; then
                echo "‚úÖ Health check passed - Application is healthy"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
                  # Show current status
                  pm2 status || true
                  sleep 5
                else
                  echo "‚ö†Ô∏è Health check failed after $MAX_RETRIES attempts"
                  echo "Application is likely still booting or has errors. Showing last errors:"
                  tail -50 "$PROJECT_DIR/logs/aynbeauty-error.log" 2>/dev/null || echo "No error log available"
                  echo ""
                  echo "Full PM2 status:"
                  pm2 info aynbeauty || pm2 status
                fi
              fi
            done

            # Test static asset accessibility
            echo "üß™ Testing static assets..."
            if curl -s http://localhost:3000/_next/static/ --max-time 10 | head -c 100 > /dev/null 2>&1; then
              echo "‚úÖ Static assets accessible"
            else
              echo "‚ö†Ô∏è Could not verify static assets accessibility"
            fi

            # Verify backups are accessible
            echo "üìÇ Backup information:"
            echo "Backup directory: $BACKUP_DIR"
            if [ -d "$BACKUP_DIR" ]; then
              ls -lh "$BACKUP_DIR" | tail -5 || echo "No backups found"
            fi

            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application running at: http://66.116.199.206:3000"
            echo "üìä To check logs: pm2 logs aynbeauty"
            echo "üîÑ To restart manually: pm2 restart aynbeauty"
            echo "‚èπÔ∏è To stop: pm2 stop aynbeauty"

      - name: Notify deployment success
        if: success()
        run: echo "‚úÖ Deployment completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs above for details."
          exit 1
