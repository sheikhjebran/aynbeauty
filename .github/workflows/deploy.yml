name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Copy production environment file
        run: cp .env.prod .env.local

      - name: Build application
        run: npm run build

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          envs: DB_HOST,DB_PORT,DB_USER,DB_PASSWORD,DB_NAME,NODE_ENV
          env:
            NODE_ENV: production
          script: |
            echo "üöÄ Starting deployment..."
            set -e  # Exit on error

            # Navigate to project directory
            cd /var/www/aynbeauty
            PROJECT_DIR=$(pwd)
            BACKUP_DIR="/var/backups/aynbeauty"
            IMAGES_DIR="$PROJECT_DIR/public/uploads/products"
            BACKUP_IMAGES_DIR="$BACKUP_DIR/product-images-$(date +%Y%m%d-%H%M%S)"

            # Create backup directory if it doesn't exist
            mkdir -p "$BACKUP_DIR"
            mkdir -p "$IMAGES_DIR"

            echo "üì∏ Creating backup of product images..."
            if [ -d "$IMAGES_DIR" ] && [ "$(ls -A $IMAGES_DIR)" ]; then
              mkdir -p "$BACKUP_IMAGES_DIR"
              cp -r "$IMAGES_DIR"/* "$BACKUP_IMAGES_DIR/" 2>/dev/null || echo "‚ö†Ô∏è No existing images to backup"
              echo "‚úÖ Product images backed up to: $BACKUP_IMAGES_DIR"
              LATEST_BACKUP="$BACKUP_IMAGES_DIR"
            else
              echo "‚ÑπÔ∏è No existing product images found"
            fi

            # Stop the application gracefully
            echo "‚èπÔ∏è Stopping application..."
            if pm2 desc aynbeauty > /dev/null 2>&1; then
              pm2 stop aynbeauty
              sleep 3
              echo "‚úÖ Application stopped"
            else
              echo "‚ÑπÔ∏è Application not running in PM2"
            fi

            # Pull latest changes
            echo "üì• Pulling latest changes from main..."
            git config --global --add safe.directory /var/www/aynbeauty
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ Code updated"

            # Copy production environment
            echo "üìã Setting up production environment..."
            if [ -f ".env.prod" ]; then
              cp .env.prod .env.local
              echo "‚úÖ Production environment file copied"
            else
              echo "‚ö†Ô∏è Warning: .env.prod not found, using existing .env.local"
            fi

            # Clean build artifacts to prevent stale cache issues
            echo "üßπ Cleaning old build artifacts..."
            rm -rf .next dist .turbo || true
            echo "‚úÖ Old artifacts cleaned"

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production=false
            echo "‚úÖ Dependencies installed"

            # Build the application
            echo "üî® Building Next.js application..."
            npm run build
            if [ $? -eq 0 ]; then
              echo "‚úÖ Build completed successfully"
            else
              echo "‚ùå Build failed! Rolling back..."
              exit 1
            fi

            # Restore product images
            echo "üì∏ Restoring product images..."
            mkdir -p "$IMAGES_DIR"
            if [ -d "$LATEST_BACKUP" ] && [ "$(ls -A $LATEST_BACKUP)" ]; then
              cp -r "$LATEST_BACKUP"/* "$IMAGES_DIR/" 2>/dev/null
              echo "‚úÖ Product images restored"
            else
              echo "‚ÑπÔ∏è No backup images to restore"
            fi

            # Update database schema (if migration exists)
            echo "üóÑÔ∏è Updating database schema..."
            DB_HOST="${DB_HOST:-127.0.0.1}"
            DB_PORT="${DB_PORT:-3306}"
            if [ -f "migrate-image-urls.sql" ]; then
              mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < migrate-image-urls.sql && echo "‚úÖ Database migration completed" || echo "‚ö†Ô∏è Database migration skipped"
            else
              echo "‚ÑπÔ∏è No database migrations to run"
            fi

            # Set proper permissions
            echo "üîê Setting file permissions..."
            sudo chown -R www-data:www-data "$PROJECT_DIR" 2>/dev/null || chown -R nobody "$PROJECT_DIR"
            sudo chmod -R 755 "$PROJECT_DIR" 2>/dev/null || chmod -R 755 "$PROJECT_DIR"
            sudo chmod -R 775 "$IMAGES_DIR" 2>/dev/null || chmod -R 775 "$IMAGES_DIR"
            echo "‚úÖ Permissions set"

            # Start or restart the application with PM2
            echo "üîÑ Starting application with PM2..."
            if pm2 desc aynbeauty > /dev/null 2>&1; then
              pm2 restart aynbeauty
              echo "‚úÖ Application restarted"
            else
              pm2 start ecosystem.config.js
              echo "‚úÖ Application started"
            fi

            # Wait for application to be ready - increased timeout
            echo "‚è≥ Waiting for application startup..."
            sleep 10

            # Show PM2 status
            echo "üìä PM2 Application status:"
            pm2 status
            echo ""
            pm2 info aynbeauty || true

            # Test the application health with extended timeout
            echo "üß™ Testing application health..."
            RETRY_COUNT=0
            MAX_RETRIES=10
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3000/api/health --max-time 30 --silent > /dev/null 2>&1; then
                echo "‚úÖ Health check passed - Application is healthy"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
                  # Show current status
                  pm2 status || true
                  sleep 5
                else
                  echo "‚ö†Ô∏è Health check failed after $MAX_RETRIES attempts"
                  echo "Application is likely still booting or has errors. Showing last errors:"
                  tail -50 "$PROJECT_DIR/logs/aynbeauty-error.log" 2>/dev/null || echo "No error log available"
                  echo ""
                  echo "Full PM2 status:"
                  pm2 info aynbeauty || pm2 status
                fi
              fi
            done

            # Verify backups are accessible
            echo "üìÇ Backup information:"
            echo "Backup directory: $BACKUP_DIR"
            if [ -d "$BACKUP_DIR" ]; then
              ls -lh "$BACKUP_DIR" | tail -5 || echo "No backups found"
            fi

            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application running at: http://66.116.199.206:3000"
            echo "üìä To check logs: pm2 logs aynbeauty"
            echo "üîÑ To restart manually: pm2 restart aynbeauty"
            echo "‚èπÔ∏è To stop: pm2 stop aynbeauty"

      - name: Notify deployment success
        if: success()
        run: echo "‚úÖ Deployment completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs above for details."
          exit 1
